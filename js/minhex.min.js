function initializeScale(){l=L/sizeNumber,fontSize=l*textDimension/110}function sendScore(e,t){var i=new XMLHttpRequest;i.open("POST",addUserURL,!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.send("username="+e+"&score="+t),swal({title:"Partita finita",text:"Cosa vuoi fare?",showCancelButton:!0,confirmButtonText:"Gioca ancora!",cancelButtonText:"Mostra classifica",showConfirmButton:!0}).then(function(e){refreshNewGame()}).catch(function(e){window.location="hof/"})}function mouseOver(){"virgin"==this.state&&this.animate({fill:over_clr},anim_dur,mina.easein)}function mouseOut(){"virgin"==this.state&&this.animate({fill:base_clr},anim_dur,mina.easeout)}function drawCell(e,t){var i,n=Math.sqrt(3)/2,o=l-m,s=x0+e*l/2,r=y0+t*l*n,a={fill:base_clr,strokeWidth:stroke_width,stroke:stroke_clr};return i=(e+t)%2?field.polygon(s-o/2+m*n,r+m/2,s,r+o*n-m*n,s+o/2-m*n,r+m/2).attr(a):field.polygon(s,r+m,s-l/2+m*n,r+l*n-m/2,s+l/2-m*n,r+l*n-m/2).attr(a),i.pos=[e,t],i.count=0,i.mouseover(mouseOver),i.mouseout(mouseOut),i}function textOnCell(e,t){var i=x0+e[0]*l/2,n=y0+e[1]*l*Math.sqrt(3)/2+((e[0]+e[1])%2?1.15:1.85)*l*Math.sqrt(3)/6,o={"text-anchor":"middle","alignment-baseline":"central"};return o["font-size"]=fontSize+"em",o["font-family"]=font,o["font-weight"]=600,o.fill=fontColor,field.text(i,n,t).attr(o)}function Grid(e,t){function i(e){return e.split(",").map(parseFloat)}this.BOMBS=t,this.STARTED=!1,this.FINISHED=!1,this.cell={},this.clickedCells=0,this.remBmbs=t,this.clicks=0,this.score=0,this.refreshscore=function(e){scoreInd.innerHTML=`${e}`,scoreBox.classList.toggle("animating"),setTimeout(function(){scoreBox.classList.toggle("animating")},400)},this.finalBonus=function(){for(var e in bombscore=0,this.cell)"flag"==this.cell[e].state&&(bombscore+=this.cell[e].isBomb?rightFlagBonus:wrongFlagPenalty);return bombscore},this.mouseClick=function(e){return function(){if(doubleClick.waitingSndClick)return this.grid.toggleFlag(e),clearTimeout(doubleClick.lastClick),void(doubleClick.waitingSndClick=!1);doubleClick.waitingSndClick=!0;var t=function(){doubleClick.waitingSndClick=!1,this.grid.openCell(e,human=!0)};doubleClick.lastClick=setTimeout(t,doubleClick.mouseClickDelay)}},this.refreshBombs=function(e){this.remBmbs+=e,this.remBmbs>=0&&(remainingBombsInd.innerHTML=this.remBmbs,remainingBombsBox.classList.toggle("animating"),setTimeout(function(){remainingBombsBox.classList.toggle("animating")},400))},this.openCell=function(e,t=!1){if(!this.FINISHED){var i=this.cell[e];if(this.STARTED||(this.placeBombs(e),this.STARTED=!0),"virgin"==i.state){if(this.clickedCells++,t&&(this.score++,this.refreshscore(this.score)),i.state="clicked",i.isBomb){for(c of(i.animate({fill:bomb_clr},anim_dur,mina.easein),this.score--,this.FINISHED=!0,score=this.score+this.finalBonus(),this.refreshscore(score),swal({title:"Kaboom!",input:"text",text:`Le tue cervella sono spappolate su tutti i muri... fa' più attenzione alle mine la prossima volta! Il tuo punteggio è ${score}`,inputPlaceholder:"username",inputAttributes:{"aria-label":"Inserisci il tuo nome..."},showConfirmButton:!0}).then(function(e){sendScore(e,score)}),Object.keys(this.cell)))this.cell[c].isBomb&&c!=e&&(this.cell[c].animate({fill:bomb2_clr},anim_dur,mina.easein),this.cell[c].state="clicked");return}if(i.animate({fill:clicked_clr,scale:.2},anim_dur,mina.easein),i.count)textOnCell(i.pos,i.count.toString()).click(this.mouseClick(e));else for(c of i.nbHood)this.openCell(c)}else if("clicked"==i.state){var n=0,o=!1,s=0;for(c of i.nbHood)"flag"==this.cell[c].state&&n++;if(n==i.count){for(c of i.nbHood)"virgin"==this.cell[c].state&&(this.openCell(c),s++,o=!0);o&&t&&(this.score+=s,this.refreshscore(this.score))}}this.checkVictory()}},this.checkVictory=function(){this.clickedCells==6*e*e&&(score=this.score+this.finalBonus(),this.refreshscore(score),swal({title:"Ottimo lavoro!",input:"text",text:`Hai trovato tutte le bombe, tu sì che hai fiuto! Il tuo punteggio finale è ${score}`,inputPlaceholder:"username",inputAttributes:{"aria-label":"Inserisci il tuo nome..."},showConfirmButton:!0}).then(function(e){sendScore(e,score)}))},this.toggleFlag=function(e){if(!this.FINISHED&&this.STARTED){var t=this.cell[e];switch(t.state){case"virgin":if(this.remBmbs<=0)return;t.state="flag",t.animate({fill:flag_clr},anim_dur,mina.easein),this.clickedCells++,this.score++,this.refreshBombs(-1);break;case"flag":t.state="virgin",t.animate({fill:base_clr},anim_dur,mina.easeout),this.clickedCells--,this.score--,this.refreshBombs(1)}this.refreshscore(this.score),this.checkVictory()}},this.addCell=function(e,t){var i=drawCell(e,t);i.isBomb=!1,i.state="virgin",i.click(this.mouseClick([e,t])),i.grid=this,i.node.snapObj=i,i.node.addEventListener("contextmenu",function(){this.snapObj.grid.toggleFlag([e,t])}),i.nbHood=[],this.cell[[e,t]]=i},this.nbHoodOf=function(e){var t,i=[],n=e[0],o=e[1];for(k of[-2,-1,1,2])i.push([n+k,o]);for(k of[-1,-0,1])i=i.concat([[n+k,o-1],[n+k,o+1]]);return t=(n+o)%2?-1:1,i=i.concat([[n-2,o+t],[n+2,o+t]]),i},this.placeBombs=function(e){var t=this.cell[e].nbHood.map(function(e){return e.toString()});t.push(e.toString());for(var i=Object.keys(this.cell).filter(function(e){return-1==t.indexOf(e)}),n=0;n<this.BOMBS;n++){var o=Math.floor(Math.random()*i.length),s=this.cell[i[o]];for(nextToBomb of(s.isBomb=!0,s.nbHood))this.cell[nextToBomb].count++;i.splice(o,1)}};for(var n=0;n<e;n++)for(var o=-n;o<2*e+n+1;o++)this.addCell(o,n);for(n=e;n<2*e;n++)for(o=n+1-2*e;o<4*e-n;o++)this.addCell(o,n);var s=Object.keys(this.cell);for(c of s)this.cell[c].nbHood=this.nbHoodOf(i(c)).filter(function(e){return-1!=s.indexOf(e.toString())});this.refreshBombs(0)}function wheelSelect(e,t){var i=.01,n=e.deltaY||8*e.detail;if("bomb"==t){var o=bombsNumberFloat-n*i,s=parseInt(o);compatibilitySizeBomb(sizeNumber,s)&&(bombsNumberFloat=o,bombsNumber=s,m_bomb.node.innerHTML=bombsNumber)}else if("size"==t){var l=sizeNumberFloat-n*i,r=parseInt(l);compatibilitySizeBomb(r,bombsNumber)&&(sizeNumberFloat=l,sizeNumber=r,m_size.node.innerHTML=sizeNumber)}}function compatibilitySizeBomb(e,t){return e>0&&t>0&&t<=bombratio*(6*e*e)-13}function dragSelect(e){var t=.1;return function(i,n){if(!(Math.abs(n)+Math.abs(i)<dragTolerance))if(dragging=!0,"bomb"==e){var o=B-n*t,s=parseInt(o);compatibilitySizeBomb(sizeNumber,s)&&(bombsNumberFloat=o,bombsNumber=s,m_bomb.node.innerHTML=bombsNumber)}else if("size"==e){var l=N-n*t,r=parseInt(l);compatibilitySizeBomb(r,bombsNumber)&&(sizeNumberFloat=l,sizeNumber=r,m_size.node.innerHTML=sizeNumber)}}}function closemenu(){var e=1e3;menu_hole_shadow.attr({opacity:".3"}),menu_hole.animate({r:0},e,mina.bounce),menu_hole_shadow.animate({r:0,opacity:".1"},e,mina.bounce),setTimeout(function(){menu.attr({display:"none"})},e),setTimeout(function(){scroll_hint.className="hidden"},1500),initializeScale(),grid=new Grid(sizeNumber,bombsNumber)}function openmenu(){var e=800;menu_hole.animate({r:menu_hex_points[1][0]},e,mina.easeout)}function refreshNewGame(){window.location=window.location.href.split("?")[0]+"?n="+sizeNumber+"&b="+bombsNumber}var grid;const addUserURL="hof/addscore.php";argv={},window.location.search.substring(1).split("&").forEach(function(e){var t=e.split("=");argv[t[0]]=t[1]}),swal.setDefaults({background:"#5A3120 url(css/img/tile.png)",confirmButtonColor:"#f8b71b",showCloseButton:!0,showConfirmButton:!1});var N=parseInt(argv.n)||5,dimension=2.46*N,B=parseInt(argv.b)||30,sizeNumber=N,bombsNumber=B,base_clr="#76B918",field_bg_color="#190900",field_bg_opacity="1",stroke_clr="rgba(0,0,0,.1)",stroke_width="2",clicked_clr="#507521",over_clr="#B4E575",bomb_clr="#C10F08",bomb2_clr="#950601",flag_clr="#f8b71b",anim_dur=130,textDimension=2.1,fontColor="#fff",font="OpenSansBold",fieldMargin=.05,bodyMarginWidth=.1,bodyMarginHeight=.1,w=window,d=document,e=d.documentElement,g=d.getElementsByTagName("field")[0],width=w.innerWidth||e.clientWidth||g.clientWidth,height=w.innerHeight||e.clientHeight||g.clientHeight,centerX=width/2,centerY=height/2,field=Snap("#field"),hsr3=Math.pow(4,.4)/2;const bombratio=.5;wrongFlagPenalty=-5,rightFlagBonus=5;var score=0;height/width<hsr3?(fieldHeight=height*(1-2*bodyMarginHeight),fieldWidth=fieldHeight/hsr3):(fieldWidth=width*(1-2*bodyMarginWidth),fieldHeight=fieldWidth*hsr3),document.getElementById("field").setAttribute("width",fieldWidth),document.getElementById("field").setAttribute("height",fieldHeight);var l,fontSize,m=.1,x0=.5*fieldWidth*(.5+fieldMargin),y0=fieldHeight*fieldMargin,doubleClick={};doubleClick.mouseClickDelay=250,doubleClick.lastClickTime=+new Date,doubleClick.waitingSndClick=!1,doubleClick.lastClick=null;var L=fieldWidth*(.5-fieldMargin),menu=Snap("#menu");document.getElementById("menu").setAttribute("width",fieldWidth),document.getElementById("menu").setAttribute("height",fieldHeight);var menu_hex_points=new Array;menu_hex_points.push([x0,y0]),menu_hex_points.push([x0+L,y0]),menu_hex_points.push([x0+1.5*L,y0+L*hsr3]),menu_hex_points.push([x0+L,y0+L*hsr3*2]),menu_hex_points.push([x0,y0+L*hsr3*2]),menu_hex_points.push([x0-L/2,y0+L*hsr3]);var menu_center=[menu_hex_points[0][0]+(menu_hex_points[1][0]-menu_hex_points[0][0])/2,menu_hex_points[2][1]],menu_play_clr=base_clr,menu_hex_clr=menu_play_clr,menu_bomb_clr="#E61913",menu_size_clr="#F5B10A",menu_fame_clr="clicked_clr",menuopt_shadow=menu.filter(Snap.filter.shadow(0,1,3,"#000",.3)),menu_hex=menu.polygon(menu_hex_points).attr({fill:menu_hex_clr}),menu_hex_holemask=menu.polygon(menu_hex_points).attr({fill:"#fff"}),menu_play=menu.polygon(menu_hex_points[0],menu_hex_points[1],menu_hex_points[4],menu_hex_points[5]).attr({fill:menu_play_clr}),menu_bomb=menu.polygon(menu_center,menu_hex_points[3],menu_hex_points[4]).attr({fill:menu_bomb_clr,filter:menuopt_shadow}),menu_size=menu.polygon(menu_center,menu_hex_points[2],menu_hex_points[3]).attr({fill:menu_size_clr,filter:menuopt_shadow}),fieldshadow=field.filter(Snap.filter.shadow(0,6,12,"#000",.4)),field_bg=field.polygon(menu_hex_points).attr({fill:field_bg_color,opacity:field_bg_opacity,filter:fieldshadow,mask:menu_hole}),m_text_opt={"text-anchor":"middle","alignment-baseline":"central"};m_text_opt["font-size"]=parseInt(.1*L)+"pt",m_text_opt["font-weight"]=600,m_text_opt.fill="#fff";var bombBox=.35,sizeBox=.35,playBox=.35,m_bomb=menu.text(menu_center[0],1.75*menu_center[1],B).attr(m_text_opt),m_bomb_icon=menu.image("img/menu/bomb.png",menu_center[0]-L*bombBox*.5,1.25*menu_center[1],L*bombBox,L*bombBox),m_size=menu.text(menu_hex_points[3][0],1.6*menu_center[1],N).attr(m_text_opt),m_size_icon=menu.image("img/menu/size.png",menu_hex_points[3][0]-L*sizeBox*.5,1.1*menu_center[1],L*sizeBox,L*sizeBox),m_play=menu.text(menu_center[0]-.95*L*playBox,menu_center[1],"PLAY").attr(m_text_opt),m_play_icon=menu.image("img/menu/play.png",menu_hex_points[5][0]+L*playBox*.25,menu_center[1]-L*playBox*.5,L*playBox,L*playBox);m_play.attr({fill:"#1f1f1f"});var scroll_hint=document.getElementById("scroll_hint"),rematch_button=document.getElementById("rematch"),remainingBombsInd=document.getElementById("Bombs");scoreInd=document.getElementById("Score"),remainingBombsBox=document.getElementById("bombs_box"),scoreBox=document.getElementById("score_box");var menu_play_btn=menu.group(menu_play,m_play,m_play_icon),menu_size_opt=menu.group(menu_size,m_size,m_size_icon),menu_bomb_opt=menu.group(menu_bomb,m_bomb,m_bomb_icon),menu_hole=menu.circle(menu_center[0],menu_center[1],0).attr({fill:"#fff"}),menu_hole_shadow=menu.circle(menu_center[0],menu_center[1]+2,menu_hex_points[1][0]+45).attr({fill:"#000",opacity:"0",mask:menu_hex_holemask}),menu_group=menu.group(menu_hex,menu_play,m_play,m_play_icon,menu_bomb,m_bomb,m_bomb_icon,menu_size,m_size,m_size_icon).attr({mask:menu_hole}),bombsNumberFloat=1*B,sizeNumberFloat=1*N,maxsize=14,dragging=!1,dragTolerance=5;menu_group.node.onclick=function(){1!=dragging&&closemenu()},document.oncontextmenu=function(){return!1};var mousewheelevt=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel",wheelBomb=function(e){wheelSelect(e,"bomb")},wheelSize=function(e){wheelSelect(e,"size")};document.attachEvent?(menu_bomb.node.attachEvent("on"+mousewheelevt,wheelBomb),m_bomb_icon.node.attachEvent("on"+mousewheelevt,wheelBomb),m_bomb.node.attachEvent("on"+mousewheelevt,wheelBomb),menu_size.node.attachEvent("on"+mousewheelevt,wheelSize),m_size_icon.node.attachEvent("on"+mousewheelevt,wheelSize),m_size.node.attachEvent("on"+mousewheelevt,wheelSize)):document.addEventListener&&(menu_bomb.node.addEventListener(mousewheelevt,wheelBomb),m_bomb_icon.node.addEventListener(mousewheelevt,wheelBomb,!1),m_bomb.node.addEventListener(mousewheelevt,wheelBomb,!1),menu_size.node.addEventListener(mousewheelevt,wheelSize,!1),m_size_icon.node.addEventListener(mousewheelevt,wheelSize,!1),m_size.node.addEventListener(mousewheelevt,wheelSize,!1));var dragChangeSpeed=4,stopDragDelay=100,stopDrg=function(){setTimeout(function(){dragging=!1},stopDragDelay)};menu_bomb.node.setAttribute("draggable","true"),menu_bomb.drag(dragSelect("bomb"),function(){},function(){stopDrg(),B=bombsNumber}),m_bomb_icon.node.setAttribute("draggable","true"),m_bomb_icon.drag(dragSelect("bomb"),function(){},function(){stopDrg(),B=bombsNumber}),m_bomb.node.setAttribute("draggable","true"),m_bomb.drag(dragSelect("bomb"),function(){},function(){stopDrg(),B=bombsNumber}),menu_size.node.setAttribute("draggable","true"),menu_size.drag(dragSelect("size"),function(){},function(){N=sizeNumber,stopDrg()}),m_size_icon.node.setAttribute("draggable","true"),m_size_icon.drag(dragSelect("size"),function(){},function(){N=sizeNumber,stopDrg()}),m_size.node.setAttribute("draggable","true"),m_size.drag(dragSelect("size"),function(){dragging=!0},function(){N=sizeNumber,stopDrg()}),openmenu();