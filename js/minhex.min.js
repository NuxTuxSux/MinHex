function initializeScale(){l=L/sizeNumber,fontSize=l*textDimension/110}function sendScore(e,t){var n=new XMLHttpRequest;n.open("POST",addUserURL,!0),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send("username="+e+"&score="+t),swal({title:"Match over",text:"What do you want to do now?",showCancelButton:!0,confirmButtonText:"Play again!",cancelButtonText:"Hall Of Fame",showConfirmButton:!0}).then(function(e){refreshNewGame()}).catch(function(e){window.location="hof/"})}function mouseOver(){"virgin"==this.state&&this.animate({fill:over_clr},anim_dur,mina.easein)}function mouseOut(){"virgin"==this.state&&this.animate({fill:base_clr},anim_dur,mina.easeout)}function drawCell(e,t){var n,i=Math.sqrt(3)/2,o=l-m,s=x0+e*l/2,r=y0+t*l*i,a={fill:base_clr,strokeWidth:stroke_width,stroke:stroke_clr};return n=(e+t)%2?field.polygon(s-o/2+m*i,r+m/2,s,r+o*i-m*i,s+o/2-m*i,r+m/2).attr(a):field.polygon(s,r+m,s-l/2+m*i,r+l*i-m/2,s+l/2-m*i,r+l*i-m/2).attr(a),n.pos=[e,t],n.count=0,n.mouseover(mouseOver),n.mouseout(mouseOut),n}function textOnCell(e,t){var n=x0+e[0]*l/2,i=y0+e[1]*l*Math.sqrt(3)/2+((e[0]+e[1])%2?1.15:1.85)*l*Math.sqrt(3)/6,o={"text-anchor":"middle","alignment-baseline":"central"};return o["font-size"]=fontSize+"em",o["font-family"]=font,o["font-weight"]=600,o.fill=fontColor,field.text(n,i,t).attr(o)}function Grid(e,t){function n(e){return e.split(",").map(parseFloat)}this.BOMBS=t,this.STARTED=!1,this.FINISHED=!1,this.cell={},this.clickedCells=0,this.remBmbs=t,this.clicks=0,this.score=0,this.refreshscore=function(e){scoreInd.innerHTML=`${e}`,scoreInd.classList.toggle("animating"),setTimeout(function(){scoreInd.classList.toggle("animating")},400)},this.finalBonus=function(){for(var e in bombscore=0,this.cell)"flag"==this.cell[e].state&&(bombscore+=this.cell[e].isBomb?rightFlagBonus:wrongFlagPenalty);return bombscore},this.mouseClick=function(e){return function(){if(doubleClick.waitingSndClick)return this.grid.toggleFlag(e),clearTimeout(doubleClick.lastClick),void(doubleClick.waitingSndClick=!1);doubleClick.waitingSndClick=!0;var t=function(){doubleClick.waitingSndClick=!1,this.grid.openCell(e,human=!0)};doubleClick.lastClick=setTimeout(t,doubleClick.mouseClickDelay)}},this.refreshBombs=function(e){this.remBmbs+=e,this.remBmbs>=0&&(remainingBombsInd.innerHTML=this.remBmbs)},this.openCell=function(e,t=!1){if(!this.FINISHED){var n=this.cell[e];if(this.STARTED||(this.placeBombs(e),this.STARTED=!0),"virgin"==n.state){if(this.clickedCells++,t&&(this.score++,this.refreshscore(this.score)),n.state="clicked",n.isBomb){for(c of(n.animate({fill:bomb_clr},anim_dur,mina.easein),this.score--,this.FINISHED=!0,score=this.score+this.finalBonus(),this.refreshscore(score),swal({title:"Damn!",input:"text",text:`Pieces of your fleshy brain are all over the walls. Pay more attention to mines next time! However your score is ${score}`,inputPlaceholder:"username",inputAttributes:{"aria-label":"Type your username"},showConfirmButton:!0}).then(function(e){sendScore(e,score)}),Object.keys(this.cell)))this.cell[c].isBomb&&c!=e&&(this.cell[c].animate({fill:bomb2_clr},anim_dur,mina.easein),this.cell[c].state="clicked");return}if(n.attr({fill:clicked_clr}),n.count)textOnCell(n.pos,n.count.toString()).click(this.mouseClick(e));else for(c of n.nbHood)this.openCell(c)}else if("clicked"==n.state){var i=0,o=!1,s=0;for(c of n.nbHood)"flag"==this.cell[c].state&&i++;if(i==n.count){for(c of n.nbHood)"virgin"==this.cell[c].state&&(this.openCell(c),s++,o=!0);o&&t&&(this.score+=s,this.refreshscore(this.score))}}this.checkVictory()}},this.checkVictory=function(){this.clickedCells==6*e*e&&(score=this.score+this.finalBonus(),this.refreshscore(score),swal({title:"Awesome!",input:"text",text:`You are a real mine survive, good job your score is ${score}`,inputPlaceholder:"username",inputAttributes:{"aria-label":"Type your username"},showConfirmButton:!0}).then(function(e){sendScore(e,score)}))},this.toggleFlag=function(e){if(!this.FINISHED&&this.STARTED){var t=this.cell[e];switch(t.state){case"virgin":if(this.remBmbs<=0)return;t.state="flag",t.animate({fill:flag_clr},anim_dur,mina.easein),this.clickedCells++,this.score++,this.refreshBombs(-1);break;case"flag":t.state="virgin",t.animate({fill:base_clr},anim_dur,mina.easeout),this.clickedCells--,this.score--,this.refreshBombs(1)}this.refreshscore(this.score),this.checkVictory()}},this.addCell=function(e,t){var n=drawCell(e,t);n.isBomb=!1,n.state="virgin",n.click(this.mouseClick([e,t])),n.grid=this,n.node.snapObj=n,n.node.addEventListener("contextmenu",function(){this.snapObj.grid.toggleFlag([e,t])}),n.nbHood=[],this.cell[[e,t]]=n},this.nbHoodOf=function(e){var t,n=[],i=e[0],o=e[1];for(k of[-2,-1,1,2])n.push([i+k,o]);for(k of[-1,-0,1])n=n.concat([[i+k,o-1],[i+k,o+1]]);return t=(i+o)%2?-1:1,n=n.concat([[i-2,o+t],[i+2,o+t]]),n},this.placeBombs=function(e){var t=this.cell[e].nbHood.map(function(e){return e.toString()});t.push(e.toString());for(var n=Object.keys(this.cell).filter(function(e){return-1==t.indexOf(e)}),i=0;i<this.BOMBS;i++){var o=Math.floor(Math.random()*n.length),s=this.cell[n[o]];for(nextToBomb of(s.isBomb=!0,s.nbHood))this.cell[nextToBomb].count++;n.splice(o,1)}};for(var i=0;i<e;i++)for(var o=-i;o<2*e+i+1;o++)this.addCell(o,i);for(i=e;i<2*e;i++)for(o=i+1-2*e;o<4*e-i;o++)this.addCell(o,i);var s=Object.keys(this.cell);for(c of s)this.cell[c].nbHood=this.nbHoodOf(n(c)).filter(function(e){return-1!=s.indexOf(e.toString())});this.refreshBombs(0)}function wheelSelect(e,t){var n=.01,i=e.deltaY||8*e.detail;if("bomb"==t){var o=bombsNumberFloat-i*n,s=parseInt(o);compatibilitySizeBomb(sizeNumber,s)&&(bombsNumberFloat=o,bombsNumber=s,m_bomb.node.innerHTML=bombsNumber)}else if("size"==t){var l=sizeNumberFloat-i*n,r=parseInt(l);compatibilitySizeBomb(r,bombsNumber)&&(sizeNumberFloat=l,sizeNumber=r,m_size.node.innerHTML=sizeNumber)}}function compatibilitySizeBomb(e,t){return e>0&&t>0&&t<=bombratio*(6*e*e)-13}function dragSelect(e){var t=.1;return function(n,i){if(!(Math.abs(i)+Math.abs(n)<dragTolerance))if(dragging=!0,"bomb"==e){var o=B-i*t,s=parseInt(o);compatibilitySizeBomb(sizeNumber,s)&&(bombsNumberFloat=o,bombsNumber=s,m_bomb.node.innerHTML=bombsNumber)}else if("size"==e){var l=N-i*t,r=parseInt(l);compatibilitySizeBomb(r,bombsNumber)&&(sizeNumberFloat=l,sizeNumber=r,m_size.node.innerHTML=sizeNumber)}}}function closemenu(){var e=1e3;menu_hole_shadow.attr({opacity:".3"}),menu_hole.animate({r:0},e,mina.bounce),menu_hole_shadow.animate({r:0,opacity:".1"},e,mina.bounce),setTimeout(function(){menu.attr({display:"none"})},e),document.getElementById("hofLink").classList.remove("nodisplay"),showRematch(1),setTimeout(function(){scroll_hint.className="hidden",remainingBombsInd.className="visible"},1500),initializeScale(),grid=new Grid(sizeNumber,bombsNumber)}function openmenu(){var e=800;menu_hole.animate({r:menu_hex_points[1][0]},e,mina.easeout)}function showRematch(e){autohideT=e?1e3:2e3,anim=200,remainingBombsInd.className="hidden",setTimeout(function(){rematch_button.className="visible",remainingBombsInd.className="nodisplay"},anim),setTimeout(function(){rematch_button.className="hidden"},autohideT),setTimeout(function(){rematch_button.className="nodisplay",remainingBombsInd.className="visible"},autohideT+anim)}function refreshNewGame(){window.location=window.location.href.split("?")[0]+"?n="+sizeNumber+"&b="+bombsNumber}var grid;const addUserURL="hof/addscore.php";argv={},window.location.search.substring(1).split("&").forEach(function(e){var t=e.split("=");argv[t[0]]=t[1]}),swal.setDefaults({background:"#5A3120 url(css/img/tile.png)",confirmButtonColor:"#f8b71b",showCloseButton:!0,showConfirmButton:!1});var N=parseInt(argv.n)||5,dimension=2.46*N,B=parseInt(argv.b)||30,sizeNumber=N,bombsNumber=B,base_clr="#75b92d",field_bg_color="#000000",field_bg_opacity=".3",stroke_clr="rgba(0,0,0,.2)",stroke_width="1",clicked_clr="#507521",over_clr="#B4E575",bomb_clr="#C10F08",bomb2_clr="#950601",flag_clr="#f8b71b",anim_dur=130,textDimension=2.1,fontColor="rgba(255,255,255,.85)",font="OpenSansBold",fieldMargin=.05,bodyMarginWidth=.1,bodyMarginHeight=.1,w=window,d=document,e=d.documentElement,g=d.getElementsByTagName("field")[0],width=w.innerWidth||e.clientWidth||g.clientWidth,height=w.innerHeight||e.clientHeight||g.clientHeight,centerX=width/2,centerY=height/2,field=Snap("#field"),hsr3=Math.pow(4,.4)/2;const bombratio=.5;wrongFlagPenalty=-5,rightFlagBonus=5;var score=0;height/width<hsr3?(fieldHeight=height*(1-2*bodyMarginHeight),fieldWidth=fieldHeight/hsr3):(fieldWidth=width*(1-2*bodyMarginWidth),fieldHeight=fieldWidth*hsr3),document.getElementById("field").setAttribute("width",fieldWidth),document.getElementById("field").setAttribute("height",fieldHeight);var l,fontSize,m=.1,x0=.5*fieldWidth*(.5+fieldMargin),y0=fieldHeight*fieldMargin,doubleClick={};doubleClick.mouseClickDelay=250,doubleClick.lastClickTime=+new Date,doubleClick.waitingSndClick=!1,doubleClick.lastClick=null;var L=fieldWidth*(.5-fieldMargin),menu=Snap("#menu");document.getElementById("menu").setAttribute("width",fieldWidth),document.getElementById("menu").setAttribute("height",fieldHeight);var menu_hex_points=new Array;menu_hex_points.push([x0,y0]),menu_hex_points.push([x0+L,y0]),menu_hex_points.push([x0+1.5*L,y0+L*hsr3]),menu_hex_points.push([x0+L,y0+L*hsr3*2]),menu_hex_points.push([x0,y0+L*hsr3*2]),menu_hex_points.push([x0-L/2,y0+L*hsr3]);var menu_center=[menu_hex_points[0][0]+(menu_hex_points[1][0]-menu_hex_points[0][0])/2,menu_hex_points[2][1]],menu_play_clr=base_clr,menu_hex_clr=menu_play_clr,menu_bomb_clr="#f1241e",menu_size_clr="#F5B10A",menu_fame_clr="clicked_clr",menuopt_shadow=menu.filter(Snap.filter.shadow(0,1,3,"#000",.3)),menu_hex=menu.polygon(menu_hex_points).attr({fill:menu_hex_clr}),menu_hex_holemask=menu.polygon(menu_hex_points).attr({fill:"#fff"}),menu_play=menu.polygon(menu_hex_points[0],menu_hex_points[1],menu_hex_points[4],menu_hex_points[5]).attr({fill:menu_play_clr}),menu_bomb=menu.polygon(menu_center,menu_hex_points[3],menu_hex_points[4]).attr({fill:menu_bomb_clr,filter:menuopt_shadow}),menu_size=menu.polygon(menu_center,menu_hex_points[2],menu_hex_points[3]).attr({fill:menu_size_clr,filter:menuopt_shadow}),fieldshadow=field.filter(Snap.filter.shadow(0,6,12,"#000",.4)),field_bg=field.polygon(menu_hex_points).attr({fill:field_bg_color,opacity:field_bg_opacity,filter:fieldshadow,mask:menu_hole}),m_text_opt={"text-anchor":"middle","alignment-baseline":"central"};m_text_opt["font-size"]=parseInt(.1*L)+"pt",m_text_opt["font-weight"]=600,m_text_opt.fill="#fff";var bombBox=.35,sizeBox=.35,playBox=.35,m_bomb=menu.text(menu_center[0],1.75*menu_center[1],B).attr(m_text_opt),m_bomb_icon=menu.image("img/menu/bomb.png",menu_center[0]-L*bombBox*.5,1.25*menu_center[1],L*bombBox,L*bombBox),m_size=menu.text(menu_hex_points[3][0],1.6*menu_center[1],N).attr(m_text_opt),m_size_icon=menu.image("img/menu/size.png",menu_hex_points[3][0]-L*sizeBox*.5,1.1*menu_center[1],L*sizeBox,L*sizeBox),m_play=menu.text(menu_center[0]-.95*L*playBox,menu_center[1],"PLAY").attr(m_text_opt),m_play_icon=menu.image("img/menu/play.png",menu_hex_points[5][0]+L*playBox*.25,menu_center[1]-L*playBox*.5,L*playBox,L*playBox);m_play.attr({fill:"#1f1f1f"});var scroll_hint=document.getElementById("scroll_hint"),rematch_button=document.getElementById("rematch"),remainingBombsInd=document.getElementById("RemainingBombs");scoreInd=document.getElementById("Score");var menu_play_btn=menu.group(menu_play,m_play,m_play_icon),menu_size_opt=menu.group(menu_size,m_size,m_size_icon),menu_bomb_opt=menu.group(menu_bomb,m_bomb,m_bomb_icon),menu_hole=menu.circle(menu_center[0],menu_center[1],0).attr({fill:"#fff"}),menu_hole_shadow=menu.circle(menu_center[0],menu_center[1]+2,menu_hex_points[1][0]+45).attr({fill:"#000",opacity:"0",mask:menu_hex_holemask}),menu_group=menu.group(menu_hex,menu_play,m_play,m_play_icon,menu_bomb,m_bomb,m_bomb_icon,menu_size,m_size,m_size_icon).attr({mask:menu_hole}),bombsNumberFloat=1*B,sizeNumberFloat=1*N,maxsize=14,dragging=!1,dragTolerance=5;menu_group.node.onclick=function(){1!=dragging&&closemenu()},document.oncontextmenu=function(){return!1};var mousewheelevt=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel",wheelBomb=function(e){wheelSelect(e,"bomb")},wheelSize=function(e){wheelSelect(e,"size")};document.attachEvent?(menu_bomb.node.attachEvent("on"+mousewheelevt,wheelBomb),m_bomb_icon.node.attachEvent("on"+mousewheelevt,wheelBomb),m_bomb.node.attachEvent("on"+mousewheelevt,wheelBomb),menu_size.node.attachEvent("on"+mousewheelevt,wheelSize),m_size_icon.node.attachEvent("on"+mousewheelevt,wheelSize),m_size.node.attachEvent("on"+mousewheelevt,wheelSize)):document.addEventListener&&(menu_bomb.node.addEventListener(mousewheelevt,wheelBomb),m_bomb_icon.node.addEventListener(mousewheelevt,wheelBomb,!1),m_bomb.node.addEventListener(mousewheelevt,wheelBomb,!1),menu_size.node.addEventListener(mousewheelevt,wheelSize,!1),m_size_icon.node.addEventListener(mousewheelevt,wheelSize,!1),m_size.node.addEventListener(mousewheelevt,wheelSize,!1));var dragChangeSpeed=4,stopDragDelay=100,stopDrg=function(){setTimeout(function(){dragging=!1},stopDragDelay)};menu_bomb.node.setAttribute("draggable","true"),menu_bomb.drag(dragSelect("bomb"),function(){},function(){stopDrg(),B=bombsNumber}),m_bomb_icon.node.setAttribute("draggable","true"),m_bomb_icon.drag(dragSelect("bomb"),function(){},function(){stopDrg(),B=bombsNumber}),m_bomb.node.setAttribute("draggable","true"),m_bomb.drag(dragSelect("bomb"),function(){},function(){stopDrg(),B=bombsNumber}),menu_size.node.setAttribute("draggable","true"),menu_size.drag(dragSelect("size"),function(){},function(){N=sizeNumber,stopDrg()}),m_size_icon.node.setAttribute("draggable","true"),m_size_icon.drag(dragSelect("size"),function(){},function(){N=sizeNumber,stopDrg()}),m_size.node.setAttribute("draggable","true"),m_size.drag(dragSelect("size"),function(){dragging=!0},function(){N=sizeNumber,stopDrg()}),openmenu();